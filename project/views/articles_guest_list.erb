<div class="categories">
  <button>business</button>
  <button>education</button>
  <button>opinion</button>
  <button>foreign</button>
</div>

<div class="article_content">
  <form action="/articles/bookmarks" method="post">
    <input class="article_id" type="hidden" name="article_id"/>
    <input class="folder_name" type="hidden" name="folder_name"/>
    <i class="hidden fas fa-birthday-cake fa-2x"></i>
  </form>
  <div class="main_article">
    <p class="next hidden"><i class="fas fa-angle-left fa-2x"></i></p>
    <div>
      <h2></h2> 
      <p class="date"></p>
      <p class="result"></p>
    </div>
      <p class="previous hidden"><i class="fas fa-angle-right fa-2x"></i></p>
  </div>
</div>


<script>
const icon = document.querySelector('.article_content i')
const articleId = document.querySelector('.article_id')
const categories = document.querySelector('.categories')
const articleContent = document.querySelector('.article_content')
const result = document.querySelector('.result')
const title = document.querySelector('h2')
const publishedDate = document.querySelector('.date')
const nextBtn = document.querySelector('.next')
const previousBtn = document.querySelector('.previous')

const birthYear = <%=@year%>;
const currentYear = new Date().getFullYear()
const selectedDate = new Date()
selectedDate.setMonth(<%=@month%> -1)
selectedDate.setDate(<%=@day%>)

function getArticle(category) {
  fetch(`https://api.nytimes.com/svc/search/v2/articlesearch.json?q=${category}&fq=pub_date:${selectedDate.getFullYear()}-${selectedDate.getMonth() + 1}-${selectedDate.getDate()}&api-key=xowFFypBoDXFSCp6TjUuwy5mPmY1H6Ra`)
  .then(res => res.json())
  .then(data => {
    console.log(data)
    icon.classList.remove('hidden')
    const nextDate = new Date(selectedDate).setYear(selectedDate.getFullYear() + 1)
    
    
    if(nextDate > new Date() ) {
      nextBtn.classList.add('hidden')
    } else {
      nextBtn.classList.remove('hidden')
    }
    if (selectedDate.getFullYear() === birthYear) {
      previousBtn.classList.add('hidden')
    } else {
      previousBtn.classList.remove('hidden')
    } 
  
    if(data === []) {
      result.textContent = "Sorry, We cannot find any articles for this year!"
      return
    }
    
    num = 0
    if(data.response.docs[num].lead_paragraph === undefined) {
      result.textContent = data.response.docs[num+=1].lead_paragraph 
    } else {
      console.log(data.response.docs[num].lead_paragraph)
      result.textContent = data.response.docs[num].lead_paragraph
    }
    title.textContent = data.response.docs[num].headline.main
    articleId.value = data.response.docs[num]._id

    const anchor = document.createElement('a')
    anchor.setAttribute('href', data.response.docs[1].web_url)
    anchor.textContent = "[...]"
    result.appendChild(anchor)
    publishedDate.textContent = data.response.docs[1].pub_date.slice(0,10).replace(/-/g, " ")
  })
}

if(selectedDate > new Date()) {
  selectedDate.setYear(selectedDate.getFullYear()-1)
  getArticle("election")
} else {
  getArticle("election")
}


function differentCategory(e) {
  getArticle(e.target.textContent)
  console.log(e.target)
}


function previousPage(e) {
  if(selectedDate.getFullYear() === birthYear) {
    return
  }
  selectedDate.setYear(selectedDate.getFullYear() - 1)
  getArticle("election")
}

function nextPage(e) {
  if(selectedDate.getFullYear() === currentYear) {
    return
  }
  selectedDate.setYear(selectedDate.getFullYear() + 1)
  getArticle("election")
}

function labelFolder(str) {
  var lowerCaseStr = str.toLowerCase()
  var firstLetter = lowerCaseStr[0].toUpperCase()
  return firstLetter + lowerCaseStr.slice(1)
}

function saveToBookmark(e) {
  e.preventDefault()
  icon.style.color = "white"
  const promptValue = prompt("Please enter the folder name", "ex)Grandma")
  let folderName = document.querySelector('.article_content .folder_name')
  if(promptValue === null) {
    return
  }
  var changedFolderName = labelFolder(promptValue)
  folderName.value = changedFolderName

  
  fetch(`/api/articles/bookmarks?article_id=${articleId.value}&folder_name=${folderName.value}`, {method: "post"})
  .then(res => res.json())
  .then(data => console.log(data))
}




nextBtn.addEventListener('click', nextPage)
previousBtn.addEventListener('click', previousPage)
categories.addEventListener('click', differentCategory)
icon.addEventListener('click', saveToBookmark)
</script>
